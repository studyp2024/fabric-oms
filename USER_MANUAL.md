# 网络安全设备运维审计系统 - 用户手册

本手册旨在指导用户如何使用网络安全设备运维审计系统。系统分为 **管理员 (Admin)** 和 **运维人员 (Ops)** 两种角色。

## 1. 系统登录

*   **访问地址**: `http://<服务器IP>/` (例如 `http://192.168.23.148/`)
*   **默认账号**:
    *   **管理员**: 用户名 `admin` / 密码 `admin`
    *   **运维人员**: 用户名 `ops` / 密码 `ops`

## 2. 功能概览

| 功能模块 | 管理员 (Admin) | 运维人员 (Ops) | 说明 |
| :--- | :---: | :---: | :--- |
| **仪表盘** | ✅ | ✅ | 查看系统整体运行状态、日志统计等。 |
| **服务器列表** | ✅ | ✅ | 查看纳管的服务器信息。管理员可添加/编辑/删除服务器。 |
| **用户管理** | ✅ | ❌ | 管理系统用户，分配服务器给运维人员。 |
| **审计日志** | ✅ | ✅ | 查看所有服务器的操作日志，支持搜索和筛选。 |

## 3. 详细操作指南

### 3.1 服务器管理 (Server Management)
**路径**: 侧边栏 -> Server List

*   **查看服务器**: 列表显示所有已添加的服务器及其基本信息 (IP, SSH 用户)。
*   **添加服务器 (仅管理员)**:
    1.  点击页面右上角的 "Add Server" 按钮。
    2.  填写服务器 IP、SSH 用户名、SSH 密码。
    3.  点击 "Save" 保存。
*   **分配运维人员 (仅管理员)**:
    1.  在服务器列表中找到目标服务器。
    2.  点击 "Assign User" 按钮 (下拉框选择)。
    3.  选择一个运维人员 (Ops)，点击确认。
    *   *作用*: 被分配的运维人员将负责该服务器的维护，系统会记录该人员的操作关联。
*   **服务器状态监控**:
    *   系统每分钟自动检查一次服务器的 SSH 连接状态。
    *   **ONLINE (绿色)**: SSH 连接正常。
    *   **OFFLINE (红色)**: SSH 连接失败 (网络不通或认证失败)。

### 3.2 审计日志 (Audit Logs)
**路径**: 侧边栏 -> Audit Logs

*   **日志列表**: 实时显示从各服务器收集来的操作日志。
*   **日志字段**:
    *   **Timestamp**: 操作发生时间。
    *   **Server IP**: 来源服务器 IP。
    *   **User**: 执行操作的 SSH 用户。
    *   **Command**: 执行的具体命令。
    *   **Risk**: 敏感/高危命令会以红色高亮显示 (如 `rm -rf`, `sudo` 等)。
*   **搜索与筛选**:
    *   在顶部搜索框输入关键字 (如 IP、命令内容)，实时过滤日志。

### 3.3 用户管理 (User Management)
**路径**: 侧边栏 -> User Management (仅管理员可见)

*   **查看用户**: 显示系统内所有用户及其角色。
*   **添加用户**:
    1.  点击页面顶部的 "Add New User" 表单。
    2.  输入用户名、密码，选择角色 (ADMIN 或 OPS)。
    3.  点击 "Add User" 按钮保存。
*   **删除用户**:
    1.  在用户列表中找到目标用户。
    2.  点击右侧的 "Delete" 按钮。
    *   *注意*: 无法删除 admin 账号本身。

## 4. 目标服务器日志配置

为了让系统能收集到目标服务器的操作日志，需要在**每台被纳管的目标服务器**上执行配置脚本。该脚本会配置 SSH 会话记录功能。

**注意**: 目标服务器**无需**克隆整个项目代码，只需获取配置脚本即可。

### 4.1 获取并上传脚本

1.  **获取脚本**: 在本项目代码库中找到 `scripts/setup_remote_logging.sh` 文件。
2.  **上传至目标服务器**:
    *   使用 WinSCP、FileZilla 或 `scp` 命令将该脚本上传到目标服务器的任意目录 (例如 `/tmp` 或 `/home/user`)。
    *   *示例 (使用 scp)*:
        ```bash
        scp scripts/setup_remote_logging.sh user@target-server-ip:/tmp/
        ```

### 4.2 执行配置脚本

登录到目标服务器，执行以下命令：

```bash
# 1. 进入脚本所在目录
cd /tmp

# 2. 使用 root 权限运行脚本
sudo bash setup_remote_logging.sh
```

**脚本执行内容说明**:
*   修改 `/etc/bash.bashrc`，添加 `PROMPT_COMMAND` 以实时记录所有用户的 SSH 命令。
*   创建日志文件 `/var/log/ssh_commands.log`。
*   设置权限为 `660` (root:users)，确保安全且可读。

### 4.3 验证配置

脚本执行完成后，新的 SSH 会话将自动生效。你可以通过以下方式验证：

1.  **重新登录 SSH** 或执行 `source /etc/bash.bashrc`。
2.  执行几条命令 (如 `ls`, `pwd`)。
3.  查看日志文件:
    ```bash
    tail -f /var/log/ssh_commands.log
    ```
    你应该能看到类似以下的日志记录：
    `2023-10-27 10:00:00 | SSH_IP:192.168.1.5 | USER:ops | PWD:/home/ops | COMMAND:ls -la`

## 5. 常见问题
*   **日志未更新**: 
    *   检查目标服务器是否执行了配置脚本setup_remote_logging.sh。
    *   检查审计系统的后端服务是否运行。
    *   确认数据库中配置的 SSH 账号密码正确且有权限读取日志文件。
